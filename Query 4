--This query provides the top 3-month occurrence of the Staff based on the hours worked using with clause.
--The staff is ranked based on the hours worked every month so that they can be rewarded. 

select x.staffid, count (*) as "Top 3/month occurrence", sum (x."HOURS WORKED") as "HOURS WORKED" FROM (
SELECT Y.STAFFID, Y."HOURS WORKED" AS "HOURS WORKED", Y.MONTH, Y.RANK FROM
(SELECT Z.STAFFID, Z."HOURS WORKED" AS "HOURS WORKED", Z.MONTH,
RANK() OVER ( PARTITION BY Z.MONTH  ORDER BY Z."HOURS WORKED" DESC ) AS RANK
FROM (
SELECT STAFFID, "SUM OF HOURS WORKED" AS "HOURS WORKED", EXTRACT(month FROM SHIFTTEAMDATE) AS MONTH
FROM (
 
SELECT ST.SHIFTTEAMID, S.STAFFID, SHIFTTEAMDATE,
SUM(S.STAFFWEEKLYDISTRIBUTIONHOURS) AS "SUM OF HOURS WORKED"
  FROM SHIFTTEAM ST INNER JOIN COMPRISE_VOLUNTEERS CV ON ST.SHIFTTEAMID=CV.SHIFTTEAMID
 INNER JOIN VOLUNTEERS V ON CV.STAFFID=V.STAFFID
 INNER JOIN STAFF S ON V.STAFFID=S.STAFFID
 GROUP BY ST.SHIFTTEAMID, S.STAFFID, SHIFTTEAMDATE
 
 UNION
 
SELECT ST.SHIFTTEAMID, S.STAFFID, SHIFTTEAMDATE,
SUM(S.STAFFWEEKLYDISTRIBUTIONHOURS) AS "SUM OF HOURS WORKED"
 FROM SHIFTTEAM ST INNER JOIN COMPRISE_GRADUATEASSISTANTS CGA ON ST.SHIFTTEAMID=CGA.SHIFTTEAMID
 INNER JOIN GRADUATEASSISTANTS GA ON CGA.STAFFID=GA.STAFFID
 INNER JOIN STAFF S ON GA.STAFFID=S.STAFFID
 GROUP BY ST.SHIFTTEAMID, S.STAFFID, SHIFTTEAMDATE
 
UNION
 
 SELECT ST.SHIFTTEAMID, S.STAFFID, SHIFTTEAMDATE,
 SUM(S.STAFFWEEKLYDISTRIBUTIONHOURS) AS "SUM OF HOURS WORKED"
 FROM SHIFTTEAM ST JOIN COMPRISE_STUDENTDIRECTOR CSD ON ST.SHIFTTEAMID=CSD.SHIFTTEAMID
 JOIN STUDENTDIRECTOR SD ON CSD.STAFFID=SD.STAFFID
 JOIN STAFF S ON SD.STAFFID=S.STAFFID
  GROUP BY ST.SHIFTTEAMID, S.STAFFID, SHIFTTEAMDATE
 
UNION
 SELECT ST.SHIFTTEAMID, S.STAFFID, SHIFTTEAMDATE,
 SUM(S.STAFFWEEKLYDISTRIBUTIONHOURS) AS "SUM OF HOURS WORKED"
 FROM SHIFTTEAM ST JOIN COMPRISE_CHAIRS CC ON ST.SHIFTTEAMID=CC.SHIFTTEAMID
 JOIN CHAIRS C ON CC.STAFFID=C.STAFFID
 JOIN STAFF S ON C.STAFFID=S.STAFFID
 GROUP BY ST.SHIFTTEAMID, S.STAFFID, SHIFTTEAMDATE
 
 UNION
 
 SELECT ST.SHIFTTEAMID, S.STAFFID, SHIFTTEAMDATE,
 SUM(S.STAFFWEEKLYDISTRIBUTIONHOURS) AS "SUM OF HOURS WORKED"
 FROM SHIFTTEAM ST JOIN COMPRISE_COORDINATOR CCO ON ST.SHIFTTEAMID=CCO.SHIFTTEAMID
 JOIN COORDINATOR CO ON CCO.STAFFID=CO.STAFFID
 JOIN STAFF S ON CO.STAFFID=S.STAFFID
  GROUP BY ST.SHIFTTEAMID, S.STAFFID, SHIFTTEAMDATE
 )
 WHERE SHIFTTEAMDATE >= add_months(TRUNC(SYSDATE) + 1, -6)
 )Z)Y
 WHERE Y.RANK <= 3) X
 GROUP BY x.staffid
 ORDER BY "Top 3/month occurence" DESC, "HOURS WORKED" DESC

--The query returns the 3-month occurrence, corresponding staffID and the weekly distribution hours. 
--Inline select is used to obtain a table and then select the corresponding columns.
--Multiple unions have been used in order to join various categories of the Staff as 
--they are divided into multiple categories such as Graduate Assistants, Volunteers. 
--The top working staff can be rewarded based on their ranks.
